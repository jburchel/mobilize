{% extends "base.html" %}

{% block title %}Dashboard - Mobilize CRM{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Debug Panel -->
    <div id="debugPanel" style="display: block; margin-top: 20px; padding: 10px; border: 1px solid #ccc; background-color: #f8f9fa;">
        <h5>Debug Information</h5>
        <div id="apiRequests"></div>
        <div id="apiResponses"></div>
        <div id="errorLogs"></div>
        <button class="btn btn-sm btn-primary mt-2" onclick="testAllEndpoints()">Test All Endpoints</button>
    </div>
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Debug Panel</h5>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearDebugLogs()">Clear Logs</button>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <div id="debug-log" class="small"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Statistics Row -->
    <div class="row g-3 mb-4">
        <!-- Total People Stat Card -->
        <div class="col-12 col-md-6 col-lg-3">
            <div class="kpi-card">
                <div class="kpi-card-icon primary" style="background-color: #2a5183;">
                    <i class="fas fa-users"></i>
                </div>
                <div class="kpi-card-content">
                    <div class="kpi-card-title">Total People</div>
                    <div class="kpi-card-value">{{ stats.people_count }}</div>
                    <div class="kpi-card-comparison positive">
                        <span class="kpi-card-comparison-icon">↑</span> Active
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Churches Stat Card -->
        <div class="col-12 col-md-6 col-lg-3">
            <div class="kpi-card">
                <div class="kpi-card-icon success" style="background-color: #39A949;">
                    <i class="fas fa-church"></i>
                </div>
                <div class="kpi-card-content">
                    <div class="kpi-card-title">Total Churches</div>
                    <div class="kpi-card-value">{{ stats.church_count }}</div>
                    <div class="kpi-card-comparison positive">
                        <span class="kpi-card-comparison-icon">↑</span> Active
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Tasks Stat Card -->
        <div class="col-12 col-md-6 col-lg-3">
            <div class="kpi-card">
                
                <div class="kpi-card-icon info" style="background-color: #0dcaf0;">
                    <i class="fas fa-tasks"></i>
                </div>
                <div class="kpi-card-content">
                    <div class="kpi-card-title">Open Tasks</div>
                    <div class="kpi-card-value">{{ stats.pending_tasks }}</div>
                    <div class="kpi-card-comparison negative">
                        <span class="kpi-card-comparison-icon">↓</span> Needs attention
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Communications Stat Card -->
        <div class="col-12 col-md-6 col-lg-3">
            <div class="kpi-card">
                <div class="kpi-card-icon warning" style="background-color: #ffc107;">
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="kpi-card-content">
                    <div class="kpi-card-title">Emails Sent</div>
                    <div class="kpi-card-value">{{ stats.recent_communications }}</div>
                    <div class="kpi-card-comparison positive">
                        <span class="kpi-card-comparison-icon">↑</span> Last 30 days
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pipeline Charts Row -->
    <div class="row g-3 mb-4">
        <!-- People Pipeline Chart -->
        <div class="col-12 col-lg-6">
            <div class="card h-100 card-border-primary-blue">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">People Pipeline</h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary test-api-btn" data-pipeline-type="person">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body d-flex flex-column justify-content-center position-relative">
                    <div id="peoplePipelineChart" style="height: 300px; width: 100%; position: relative;">
                        <!-- Canvas will be added here by JavaScript -->
                    </div>
                    <div id="people-chart-loading" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: none; justify-content: center; align-items: center; background: rgba(255,255,255,0.8); z-index: 100;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border text-primary" role="status"></div>
                            <span class="ms-2">Loading chart data...</span>
                        </div>
                    </div>
                    <div id="people-chart-error" class="alert alert-danger" style="display: none;"></div>
                    <div id="people-chart-empty" class="alert alert-info" style="display: none;">No data available</div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-secondary fs-6 p-2" id="people-total-count">Total: 0 People</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <a href="{{ url_for('pipeline.view_by_query', pipeline_id=people_pipeline.id, pipeline_type='person') if people_pipeline else '#' }}" 
                               id="people-view-pipeline" 
                               class="btn btn-sm btn-primary me-2">
                                <i class="fas fa-eye"></i> View Pipeline
                            </a>
                            <div class="btn-group btn-group-sm" id="people-chart-buttons">
                                <button type="button" class="btn btn-outline-primary chart-style-btn active" 
                                        data-chart-type="pie" data-pipeline="person">
                                    Pie
                                </button>
                                <button type="button" class="btn btn-outline-primary chart-style-btn" 
                                        data-chart-type="bar" data-pipeline="person">
                                    Bar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Church Pipeline Chart -->
        <div class="col-12 col-lg-6">
            <div class="card h-100 card-border-primary-green">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Church Pipeline</h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary test-api-btn" data-pipeline-type="church">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body d-flex flex-column justify-content-center position-relative">
                    <div id="churchPipelineChart" style="height: 300px; width: 100%; position: relative;">
                        <!-- Canvas will be added here by JavaScript -->
                    </div>
                    <div id="church-chart-loading" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: none; justify-content: center; align-items: center; background: rgba(255,255,255,0.8); z-index: 100;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border text-success" role="status"></div>
                            <span class="ms-2">Loading chart data...</span>
                        </div>
                    </div>
                    <div id="church-chart-error" class="alert alert-danger" style="display: none;"></div>
                    <div id="church-chart-empty" class="alert alert-info" style="display: none;">No data available</div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-secondary fs-6 p-2" id="church-total-count">Total: 0 Churches</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <!-- Direct hardcoded link to Church Pipeline using both URL and onclick -->
                            <a href="/pipeline/2" 
                               id="church-view-pipeline" 
                               class="btn btn-sm btn-primary me-2"
                               onclick="event.preventDefault(); window.location.href='/pipeline/2'; return false;">
                                <i class="fas fa-eye"></i> View Pipeline
                            </a>
                            <div class="btn-group btn-group-sm" id="church-chart-buttons">
                                <button type="button" class="btn btn-outline-primary chart-style-btn active" 
                                        data-chart-type="pie" data-pipeline="church">
                                    Pie
                                </button>
                                <button type="button" class="btn btn-outline-primary chart-style-btn" 
                                        data-chart-type="bar" data-pipeline="church">
                                    Bar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row g-3">
        <!-- Pending Tasks -->
        <div class="col-12 col-lg-6">
            <div class="card h-100 card-border-primary-blue">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Pending Tasks</h5>
                    <a href="{{ url_for('tasks.add') }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus"></i> New Task
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Due Date</th>
                                    <th>Priority</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in pending_tasks %}
                                <tr>
                                    <td>{{ task.title }}</td>
                                    <td>{{ task.due_date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <span class="priority-badge priority-{{ task.priority.value }}">
                                            {{ task.priority }}
                                        </span>
                                    </td>
                                    <td>
                                        <form action="{{ url_for('tasks.complete', id=task.id) }}" method="POST" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                            <button type="submit" class="btn btn-sm btn-success" title="Mark Complete">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </form>
                                        <a href="{{ url_for('tasks.edit', id=task.id) }}" class="btn btn-sm btn-primary" title="Edit">
                                            <i class="fas fa-pencil-alt"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">No pending tasks</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="col-12 col-lg-6">
            <div class="card h-100 card-border-primary-green">
                <div class="card-header">
                    <h5 class="mb-0">Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div class="activity-feed">
                        {% for activity in recent_activities %}
                        <div class="activity-item d-flex align-items-start mb-3">
                            <div class="activity-icon me-3">
                                {% if activity.type == 'person' %}
                                <i class="fas fa-user text-primary-blue"></i>
                                {% elif activity.type == 'church' %}
                                <i class="fas fa-church text-primary-green"></i>
                                {% elif activity.type == 'task' %}
                                <i class="fas fa-tasks text-primary-blue"></i>
                                {% elif activity.type == 'communication' %}
                                <i class="fas fa-comment-alt text-primary-green"></i>
                                {% endif %}
                            </div>
                            <div class="activity-content flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="activity-text">{{ activity.description }}</div>
                                    {% if activity.type == 'communication' %}
                                    <a href="{{ url_for('communications.view', id=activity.id) }}" class="btn btn-sm btn-outline-primary ms-2">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% elif activity.type == 'task' %}
                                    <a href="{{ url_for('tasks.edit', id=activity.id) }}" class="btn btn-sm btn-outline-primary ms-2">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% endif %}
                                </div>
                                <small class="text-muted">{{ activity.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-center">No recent activity</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Services Card -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title">Google Services</h5>
        </div>
        <div class="card-body">
            <p>Manage your Google integrations:</p>
            <ul class="list-group">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Gmail Integration
                    <a href="{{ url_for('auth.google_auth') }}" class="btn btn-sm btn-primary">Connect</a>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Reauthorize Google Services
                    <a href="{{ url_for('auth.reauth_google') }}" class="btn btn-sm btn-warning">Reauthorize</a>
                </li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% if current_user.first_login %}
    {% include 'onboarding/welcome_modal.html' %}
{% endif %}

{% block scripts %}
{{ super() }}
<!-- Load Chart.js from multiple CDNs for redundancy -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js" integrity="sha256-+8RZJLOWWrKgwjLo9R0mzK7G8TRKGz9++23Zlxasq0=" crossorigin="anonymous"></script>
<!-- Fallback if the first CDN fails -->
<script>
    if (typeof Chart === 'undefined') {
        console.error('Primary Chart.js failed to load. Loading backup...');
        document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==" crossorigin="anonymous" referrerpolicy="no-referrer"><\/script>');
    } else {
        console.log('Chart.js loaded successfully from primary CDN');
    }
</script>
<script>
    // Verify Chart.js is loaded
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof Chart === 'undefined') {
            console.error('CRITICAL ERROR: Chart.js failed to load from both CDNs');
            alert('Chart.js library failed to load. Please check your internet connection and try again.');
        } else {
            console.log('Chart.js is available:', Chart.version);
        }
    });
</script>
<script>
// Debug logging - run immediately on script load
console.log('[CHURCH PIPELINE DEBUG] Script loaded');
// Immediately update the church button to force it to pipeline/2
setTimeout(function() {
    const churchButton = document.getElementById('church-view-pipeline');
    if (churchButton) {
        churchButton.href = '/pipeline/2';
        churchButton.setAttribute('onclick', "event.preventDefault(); window.location.href='/pipeline/2'; return false;");
        console.log('[CHURCH PIPELINE DEBUG] Forced church button URL to /pipeline/2');
    } else {
        console.log('[CHURCH PIPELINE DEBUG] Church button not found in DOM');
    }
}, 100);

// Debug logging functions
function logDebug(message, data) {
    const debugPanel = document.getElementById('apiRequests');
    if (debugPanel) {
        const debugItem = document.createElement('div');
        debugItem.className = 'debug-item';
        debugItem.innerHTML = `<strong>${message}</strong>`;
        if (data) {
            debugItem.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
        debugPanel.appendChild(debugItem);
    }
    console.log(message, data);
}

function logError(message, error) {
    const errorLogs = document.getElementById('errorLogs');
    if (errorLogs) {
        const errorItem = document.createElement('div');
        errorItem.className = 'error-item';
        errorItem.style.color = 'red';
        errorItem.innerHTML = `<strong>ERROR:</strong> ${message}`;
        if (error) {
            errorItem.innerHTML += `<pre>${JSON.stringify(error, null, 2)}</pre>`;
        }
        errorLogs.appendChild(errorItem);
    }
    console.error(message, error);
}

function testAllEndpoints() {
    // Clear previous logs
    document.getElementById('apiRequests').innerHTML = '';
    document.getElementById('apiResponses').innerHTML = '';
    document.getElementById('errorLogs').innerHTML = '';
    
    logDebug('Testing all endpoints...');
    
    // Test each endpoint for both chart types
    API_ENDPOINTS.forEach((endpointFn, index) => {
        const personEndpoint = endpointFn('person');
        const churchEndpoint = endpointFn('church');
        
        logDebug(`Testing endpoint ${index + 1}: ${personEndpoint}`);
        fetch(personEndpoint)
            .then(response => {
                logDebug(`Person endpoint ${index + 1} status: ${response.status}`);
                return response.text();
            })
            .then(text => {
                try {
                    // Try to parse as JSON to see if it's valid
                    const data = JSON.parse(text);
                    document.getElementById('apiResponses').innerHTML += 
                        `<div><strong>Person Endpoint ${index + 1}:</strong> <span style="color:green">SUCCESS</span></div>`;
                    logDebug(`Person endpoint ${index + 1} data:`, data);
                } catch (e) {
                    // Not valid JSON
                    document.getElementById('apiResponses').innerHTML += 
                        `<div><strong>Person Endpoint ${index + 1}:</strong> <span style="color:red">INVALID JSON</span></div>`;
                    logError(`Person endpoint ${index + 1} returned invalid JSON:`, text);
                }
            })
            .catch(err => {
                document.getElementById('apiResponses').innerHTML += 
                    `<div><strong>Person Endpoint ${index + 1}:</strong> <span style="color:red">ERROR</span></div>`;
                logError(`Person endpoint ${index + 1} error:`, err.message);
            });
        
        logDebug(`Testing endpoint ${index + 1}: ${churchEndpoint}`);
        fetch(churchEndpoint)
            .then(response => {
                logDebug(`Church endpoint ${index + 1} status: ${response.status}`);
                return response.text();
            })
            .then(text => {
                try {
                    // Try to parse as JSON to see if it's valid
                    const data = JSON.parse(text);
                    document.getElementById('apiResponses').innerHTML += 
                        `<div><strong>Church Endpoint ${index + 1}:</strong> <span style="color:green">SUCCESS</span></div>`;
                    logDebug(`Church endpoint ${index + 1} data:`, data);
                } catch (e) {
                    // Not valid JSON
                    document.getElementById('apiResponses').innerHTML += 
                        `<div><strong>Church Endpoint ${index + 1}:</strong> <span style="color:red">INVALID JSON</span></div>`;
                    logError(`Church endpoint ${index + 1} returned invalid JSON:`, text);
                }
            })
            .catch(err => {
                document.getElementById('apiResponses').innerHTML += 
                    `<div><strong>Church Endpoint ${index + 1}:</strong> <span style="color:red">ERROR</span></div>`;
                logError(`Church endpoint ${index + 1} error:`, err.message);
            });
    });
}

function clearDebugLogs() {
    const debugLog = document.getElementById('debug-log');
    if (debugLog) {
        debugLog.innerHTML = '';
    }
}

// Global chart objects
let peopleChart = null;
let churchChart = null;

// Function to fetch pipeline data and update charts with fallback
function fetchPipelineChartData(chartType) {
    logDebug(`Fetching pipeline data for ${chartType}...`);
    
    // Try different endpoints in sequence
    tryFetchPipelineData(chartType, 0);
}

// Different API endpoints to try
const API_ENDPOINTS = [
    (chartType) => `/dashboard/pipeline-chart-data?type=${chartType}`,
    (chartType) => `/dashboard/api/chart-data/${chartType}`,
    (chartType) => `/dashboard/debug/chart-data/${chartType}`,
    (chartType) => `/dashboard/fallback-chart-data/${chartType}`
];

function tryFetchPipelineData(chartType, endpointIndex) {
    if (endpointIndex >= API_ENDPOINTS.length) {
        logError(`All endpoints failed for ${chartType} chart`, 'No more endpoints to try');
        const errorContainerId = chartType === 'person' ? 'people-chart-error' : 'church-chart-error';
        const errorContainer = document.getElementById(errorContainerId);
        if (errorContainer) {
            errorContainer.textContent = `Using fallback data for ${chartType} chart`;
            errorContainer.style.display = 'block';
        }
        
        // Use fallback data instead of showing an error
        console.log(`Using fallback data for ${chartType} chart`);
        if (window.fallbackChartData && window.fallbackChartData[chartType]) {
            const containerId = chartType === 'person' ? '#peoplePipelineChart' : '#churchPipelineChart';
            renderPipelineChart(chartType, containerId, window.fallbackChartData[chartType]);
        }
        return;
    }
    
    const endpoint = API_ENDPOINTS[endpointIndex](chartType);
    logDebug(`Trying endpoint ${endpointIndex + 1}/${API_ENDPOINTS.length}: ${endpoint}`);
    
    // Show error container
    const errorContainerId = chartType === 'person' ? 'people-chart-error' : 'church-chart-error';
    const errorContainer = document.getElementById(errorContainerId);
    if (errorContainer) {
        errorContainer.style.display = 'none';
    }
    
    fetch(endpoint)
        .then(response => {
            logDebug(`Response status for ${chartType} (endpoint ${endpointIndex + 1}):`, { status: response.status });
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.text(); // Get as text first to debug any JSON parsing issues
        })
        .then(text => {
            try {
                // Try to parse as JSON
                const data = JSON.parse(text);
                logDebug(`[${chartType} pipeline data from endpoint ${endpointIndex + 1}]`, data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // If we got valid data, render the chart
                if (data && data.stages) {
                    const containerId = chartType === 'person' ? '#peoplePipelineChart' : '#churchPipelineChart';
                    renderPipelineChart(chartType, containerId, data);
                    return; // Success!
                } else {
                    throw new Error('Invalid data format: missing stages');
                }
            } catch (e) {
                // JSON parsing error or other issue with the data
                logError(`JSON parsing error for ${chartType} endpoint ${endpointIndex + 1}`, { error: e.message, rawResponse: text });
                throw new Error(`Invalid JSON response: ${e.message}`);
            }
        })
        .catch(err => {
            logError(`${chartType} fetch error for endpoint ${endpointIndex + 1}`, { error: err.message });
            
            // Try the next endpoint
            setTimeout(() => {
                tryFetchPipelineData(chartType, endpointIndex + 1);
            }, 100);
        });
}

// Function to hard refresh all charts
function hardRefreshCharts() {
    console.log('Hard refreshing all charts');
    
    // Get current chart types
    const personChartType = document.querySelector('.chart-type-btn[data-pipeline-type="person"].active')?.getAttribute('data-chart-type') || 'pie';
    const churchChartType = document.querySelector('.chart-type-btn[data-pipeline-type="church"].active')?.getAttribute('data-chart-type') || 'pie';
    
    // Clear any existing charts
    if (peopleChart) {
        peopleChart.destroy();
        peopleChart = null;
    }
    
    if (churchChart) {
        churchChart.destroy();
        churchChart = null;
    }
    
    // Force fetch fresh data with cache busting
    fetchPipelineChartData('person');
    fetchPipelineChartData('church');
    
    return false; // Prevent default link behavior
}

// Function to update View Pipeline button URLs
function updateViewButtons(chartType, pipelineId) {
    if (!pipelineId) return;
    
    // Get the correct button ID
    const buttonId = chartType === 'person' ? 'people-view-pipeline' : 'church-view-pipeline';
    const button = document.getElementById(buttonId);
    
    if (button) {
        // Special case for church pipeline - always go directly to pipeline ID 2
        if (chartType === 'church') {
            const url = `/pipeline/2`;
            button.setAttribute('href', url);
            console.log(`SPECIAL CASE: Setting ${buttonId} button to fixed URL: ${url}`);
            
            // Ensure the onclick handler takes precedence
            button.setAttribute('onclick', "event.preventDefault(); window.location.href='/pipeline/2';");
        } else {
            // Format the correct URL for person pipeline
            const url = `/pipeline/view?pipeline_id=${pipelineId}`;
            button.setAttribute('href', url);
            console.log(`Updated ${buttonId} button to URL: ${url}`);
        }
    }
}

// Function to get default color if stage color is missing
function getDefaultColor(stageName) {
    // Lowercase stage name for case-insensitive matching
    const name = (stageName || '').toLowerCase();
    
    if (name.includes('promotion')) return '#3498db'; // Blue
    if (name.includes('information')) return '#2ecc71'; // Green
    if (name.includes('invitation')) return '#f1c40f'; // Yellow
    if (name.includes('confirmation')) return '#e67e22'; // Orange
    if (name.includes('enr') || name.includes('en42')) return '#9b59b6'; // Purple
    if (name.includes('automation')) return '#1abc9c'; // Teal
    
    // Default colors
    return '#95a5a6'; // Gray
}

// Function to render a pipeline chart
function renderPipelineChart(chartType, containerSelector, data) {
    console.log(`CHART DEBUG - Starting renderPipelineChart for ${chartType}`);
    
    // Verify Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('CRITICAL ERROR: Chart.js is not available when trying to render chart');
        alert('Chart.js is not available. Please refresh the page and try again.');
        return;
    }
    
    // Hide ALL loading spinners immediately - regardless of chart type
    const peopleLoading = document.getElementById('people-chart-loading');
    const churchLoading = document.getElementById('church-chart-loading');
    if (peopleLoading) peopleLoading.style.display = 'none';
    if (churchLoading) churchLoading.style.display = 'none';
    
    // Enhanced debugging - log the full data object
    console.log('CHART DEBUG - Full data object:', JSON.stringify(data, null, 2));
    
    // Check if data has the expected structure
    if (!data || !data.stages || !Array.isArray(data.stages)) {
        console.error(`Invalid chart data structure for ${chartType}:`, data);
        const errorContainer = document.getElementById(`${chartType === 'person' ? 'people' : 'church'}-chart-error`);
        if (errorContainer) {
            errorContainer.textContent = `Error: Invalid data structure received from server`;
            errorContainer.style.display = 'block';
        }
        return;
    }
    
    // Get container and prepare for chart
    const container = document.querySelector(containerSelector);
    if (!container) {
        console.error(`Cannot find chart container: ${containerSelector}`);
        return;
    }
    
    // Clear the container
    container.innerHTML = '';
    console.log(`CHART DEBUG - Cleared container ${containerSelector}`);
    
    // Create canvas for chart
    const canvasId = `${chartType}ChartCanvas`;
    const canvas = document.createElement('canvas');
    canvas.id = canvasId;
    canvas.width = container.clientWidth;
    canvas.height = 300;  // Fixed height
    canvas.style.width = '100%';
    canvas.style.height = '100%';
    container.appendChild(canvas);
    console.log(`CHART DEBUG - Created canvas with id ${canvasId}, width: ${canvas.width}, height: ${canvas.height}`);
    
    try {
        // Debug each stage
        console.log(`CHART DEBUG - ${chartType} stages:`, data.stages);
        data.stages.forEach((stage, index) => {
            console.log(`Stage ${index}:`, stage);
        });
        
        // Prepare chart data with fallbacks for missing properties
        const labels = data.stages.map(stage => stage.name || 'Unknown');
        
        // Try different property names for counts (count, contact_count, or a numeric value)
        const counts = data.stages.map(stage => {
            if (typeof stage.count === 'number') return stage.count;
            if (typeof stage.contact_count === 'number') return stage.contact_count;
            return 0; // Default to 0 if no count property found
        });
        
        const colors = data.stages.map(stage => stage.color || getRandomColor());
        
        // Debug
        console.log(`Rendering ${chartType} chart with data:`, {
            labels, counts, colors, container, canvasId
        });
        
        // Create chart context
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (!ctx) {
            throw new Error('Could not get 2D context from canvas');
        }
        
        console.log(`CHART DEBUG - Got 2D context, creating chart`);
        
        // Get chart type preference (pie or bar)
        const chartStyle = localStorage.getItem(`${chartType}ChartType`) || 'pie';
        console.log(`Using chart style: ${chartStyle}`);
        
        // Destroy existing chart if it exists
        if (window[`${chartType}Chart`]) {
            window[`${chartType}Chart`].destroy();
        }
        
        // Create the chart
        window[`${chartType}Chart`] = new Chart(ctx, {
            type: 'doughnut',  // Always use doughnut for now for simplicity
            data: {
                labels: labels,
                datasets: [{
                    label: `${chartType === 'person' ? 'People' : 'Churches'} by Stage`,
                    data: counts,
                    backgroundColor: colors,
                    borderWidth: 1,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: {
                                size: 14
                            },
                            color: '#333333'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        console.log(`CHART DEBUG - Chart created successfully:`, window[`${chartType}Chart`]);
        
        // Add total count below chart
        const totalCount = counts.reduce((a, b) => a + b, 0);
        const totalElement = document.createElement('div');
        totalElement.className = 'text-center mt-3';
        totalElement.innerHTML = `<strong>Total: ${totalCount}</strong>`;
        container.appendChild(totalElement);
        
        console.log(`CHART DEBUG - Added total count element: ${totalCount}`);
        
        // Update the total count in the card footer
        const totalCountElement = document.getElementById(`${chartType}-total-count`);
        if (totalCountElement) {
            totalCountElement.textContent = `Total: ${totalCount} ${chartType === 'person' ? 'People' : 'Churches'}`;
        }
        
    } catch (error) {
        console.error(`CHART DEBUG - Error creating chart:`, error);
        const errorContainer = document.getElementById(`${chartType === 'person' ? 'people' : 'church'}-chart-error`);
        if (errorContainer) {
            errorContainer.textContent = `Error creating chart: ${error.message}`;
            errorContainer.style.display = 'block';
        }
    }
    
    // Update total contacts in the footer
    const totalCountId = chartType === 'person' ? 'people-total-count' : 'church-total-count';
    const totalCountElem = document.getElementById(totalCountId);
    if (totalCountElem) {
        totalCountElem.textContent = `Total: ${data.total_contacts} ${chartType === 'person' ? 'People' : 'Churches'}`;
    }
    
    // Update the chart style buttons active state
    const chartButtonsId = chartType === 'person' ? 'people-chart-buttons' : 'church-chart-buttons';
    const chartButtons = document.querySelectorAll(`#${chartButtonsId} .chart-style-btn`);
    chartButtons.forEach(button => {
        const buttonType = button.getAttribute('data-chart-type');
        if (buttonType === chartStyle) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
        
        // Add event listener
        button.addEventListener('click', function() {
            const newChartType = this.getAttribute('data-chart-type');
            const pipeline = this.getAttribute('data-pipeline');
            
            // Update active state
            chartButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Save preference
            localStorage.setItem(`${pipeline}ChartType`, newChartType);
            
            // Redraw chart
            renderPipelineChart(pipeline, containerSelector, data);
        });
    });
}

// Function to test the pipeline API
function testPipelineApi(chartType) {
    const timestamp = new Date().toISOString();
    console.log(`[${timestamp}] Testing pipeline API for ${chartType}...`);
    
    // Get status element
    let statusElementId = chartType === 'person' ? 'people-chart-status' : 'church-chart-status';
    const statusElement = document.getElementById(statusElementId) || document.createElement('div');
    statusElement.id = statusElementId;
    statusElement.innerHTML = '<span class="text-info"><i class="fas fa-sync-alt fa-spin me-2"></i>Testing API...</span>';
    
    // Add status element if not present
    const chartContainer = document.querySelector(`#${chartType}PipelineChart`).parentNode;
    if (!chartContainer.contains(statusElement)) {
        chartContainer.appendChild(statusElement);
    }
    
    // Use our debug endpoint for chart data
    fetchPipelineChartData(chartType)
        .then(data => {
            console.log(`[${timestamp}] API test successful:`, data);
            
            // Calculate total contacts for display
            const totalContacts = data.total_contacts || 0;
            const contactType = chartType === 'person' ? 'People' : 'Churches';
            
            // Format stage distribution for the alert
            let stageDistribution = '';
            if (data.stages && data.stages.length > 0) {
                stageDistribution = data.stages.map(stage => 
                    `${stage.name}: ${stage.count} (${stage.percentage}%)`
                ).join('\n');
            }
            
            // Create success message
            const successMsg = `API test successful!\n\nPipeline: ${data.pipeline_name}\nTotal ${contactType}: ${totalContacts}\n\nStage Distribution:\n${stageDistribution}`;
            
            // Update UI
            statusElement.innerHTML = '<span class="text-success"><i class="fas fa-check-circle me-2"></i>API working!</span>';
            
            // Show alert with data summary
            alert(successMsg);
            
            // Force refresh the chart
            fetchPipelineChartData(chartType);
        })
        .catch(error => {
            console.error(`[${timestamp}] API test failed:`, error);
            statusElement.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle me-2"></i>API error!</span>';
            alert(`API Test Failed: ${error.message}`);
        });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - initializing charts');
    
    // Log what elements we can find
    console.log('Chart containers:',  
        document.querySelector('#peoplePipelineChart'),
        document.querySelector('#churchPipelineChart')
    );
    
    console.log('Loading indicators:',
        document.getElementById('people-chart-loading'),
        document.getElementById('church-chart-loading')
    );
    
    // Force loading indicators to be visible initially
    const peopleLoading = document.getElementById('people-chart-loading');
    const churchLoading = document.getElementById('church-chart-loading');
    
    if (peopleLoading) peopleLoading.style.display = 'flex';
    if (churchLoading) churchLoading.style.display = 'flex';
    
    // Add fallback data in case API calls fail
    window.fallbackChartData = {
        person: {
            pipeline_id: 1,
            pipeline_name: 'People Pipeline',
            stages: [
                { id: 1, name: 'NEW', count: 5, percentage: 20, color: '#3498db' },
                { id: 2, name: 'CONTACT', count: 8, percentage: 32, color: '#2ecc71' },
                { id: 3, name: 'CONNECT', count: 6, percentage: 24, color: '#f1c40f' },
                { id: 4, name: 'COMMITTED', count: 4, percentage: 16, color: '#e67e22' },
                { id: 5, name: 'COACHING', count: 2, percentage: 8, color: '#9b59b6' }
            ],
            total_contacts: 25
        },
        church: {
            pipeline_id: 2,
            pipeline_name: 'Church Pipeline',
            stages: [
                { id: 1, name: 'NEW', count: 3, percentage: 30, color: '#3498db' },
                { id: 2, name: 'CONTACT', count: 2, percentage: 20, color: '#2ecc71' },
                { id: 3, name: 'CONNECT', count: 2, percentage: 20, color: '#f1c40f' },
                { id: 4, name: 'COMMITTED', count: 2, percentage: 20, color: '#e67e22' },
                { id: 5, name: 'COACHING', count: 1, percentage: 10, color: '#9b59b6' }
            ],
            total_contacts: 10
        }
    };
    
    // Initialize charts with delay to ensure DOM is fully ready
    setTimeout(() => {
        console.log('Starting chart initialization');
        fetchPipelineChartData('person');
        fetchPipelineChartData('church');
    }, 500);
    
    // Add event listeners for API test buttons
    document.querySelectorAll('.test-api-btn').forEach(button => {
        button.addEventListener('click', function() {
            const pipeline = this.getAttribute('data-pipeline-type');
            testPipelineApi(pipeline);
        });
    });
});
</script>
{% endblock %}