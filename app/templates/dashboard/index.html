{% extends "base.html" %}

{% block title %}Dashboard - Mobilize CRM{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Statistics Row -->
    <div class="row g-3 mb-4">
        <!-- Total People Stat Card -->
        <div class="col-12 col-md-6 col-lg-3">
            <div class="kpi-card">
                <div class="kpi-card-icon primary" style="background-color: #2a5183;">
                    <i class="fas fa-users"></i>
                </div>
                <div class="kpi-card-content">
                    <div class="kpi-card-title">Total People</div>
                    <div class="kpi-card-value">{{ stats.people_count }}</div>
                    <div class="kpi-card-comparison positive">
                        <span class="kpi-card-comparison-icon">↑</span> Active
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Churches Stat Card -->
        <div class="col-12 col-md-6 col-lg-3">
            <div class="kpi-card">
                <div class="kpi-card-icon success" style="background-color: #39A949;">
                    <i class="fas fa-church"></i>
                </div>
                <div class="kpi-card-content">
                    <div class="kpi-card-title">Total Churches</div>
                    <div class="kpi-card-value">{{ stats.church_count }}</div>
                    <div class="kpi-card-comparison positive">
                        <span class="kpi-card-comparison-icon">↑</span> Active
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Tasks Stat Card -->
        <div class="col-12 col-md-6 col-lg-3">
            <div class="kpi-card">
                
                <div class="kpi-card-icon info" style="background-color: #0dcaf0;">
                    <i class="fas fa-tasks"></i>
                </div>
                <div class="kpi-card-content">
                    <div class="kpi-card-title">Open Tasks</div>
                    <div class="kpi-card-value">{{ stats.pending_tasks }}</div>
                    <div class="kpi-card-comparison negative">
                        <span class="kpi-card-comparison-icon">↓</span> Needs attention
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Communications Stat Card -->
        <div class="col-12 col-md-6 col-lg-3">
            <div class="kpi-card">
                <div class="kpi-card-icon warning" style="background-color: #ffc107;">
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="kpi-card-content">
                    <div class="kpi-card-title">Emails Sent</div>
                    <div class="kpi-card-value">{{ stats.recent_communications }}</div>
                    <div class="kpi-card-comparison positive">
                        <span class="kpi-card-comparison-icon">↑</span> Last 30 days
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pipeline Charts Row -->
    <div class="row g-3 mb-4">
        <!-- People Pipeline Chart -->
        <div class="col-12 col-lg-6">
            <div class="card h-100 card-border-primary-blue">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">People Pipeline</h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary refresh-chart-btn" data-chart-type="person">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body d-flex flex-column justify-content-center position-relative">
                    <div id="people-chart-container" style="height: 300px; width: 100%; position: relative;">
                        <!-- Chart will be rendered here -->
                    </div>
                    <div id="people-chart-loading" class="chart-loading-indicator" style="display: flex; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); justify-content: center; align-items: center;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="ms-2">Loading chart data...</div>
                    </div>
                    <div id="people-chart-error" class="alert alert-danger mt-3" style="display: none;"></div>
                    <div id="people-chart-empty" class="alert alert-info mt-3" style="display: none;">No data available for People Pipeline</div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-secondary fs-6 p-2" id="people-total-count">Total: 0 People</span>
                        </div>
                        <div>
                            <a id="people-view-pipeline" href="/pipeline/people" class="btn btn-sm btn-primary me-2">
                                <i class="fas fa-eye"></i> View Pipeline
                            </a>
                            <div class="btn-group" id="people-chart-type-buttons">
                                <button type="button" class="btn btn-sm btn-outline-secondary chart-type-btn active" 
                                        data-chart-type="pie" data-pipeline="person">
                                    Pie
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary chart-type-btn" 
                                        data-chart-type="bar" data-pipeline="person">
                                    Bar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Church Pipeline Chart -->
        <div class="col-12 col-lg-6">
            <div class="card h-100 card-border-primary-green">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Church Pipeline</h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary refresh-chart-btn" data-chart-type="church">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body d-flex flex-column justify-content-center position-relative">
                    <div id="church-chart-container" style="height: 300px; width: 100%; position: relative;">
                        <!-- Chart will be rendered here -->
                    </div>
                    <div id="church-chart-loading" class="chart-loading-indicator" style="display: flex; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); justify-content: center; align-items: center;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="ms-2">Loading chart data...</div>
                    </div>
                    <div id="church-chart-error" class="alert alert-danger mt-3" style="display: none;"></div>
                    <div id="church-chart-empty" class="alert alert-info mt-3" style="display: none;">No data available for Church Pipeline</div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-secondary fs-6 p-2" id="church-total-count">Total: 0 Churches</span>
                        </div>
                        <div>
                            <a id="church-view-pipeline" href="/pipeline/church" class="btn btn-sm btn-primary me-2">
                                <i class="fas fa-eye"></i> View Pipeline
                            </a>
                            <div class="btn-group" id="church-chart-type-buttons">
                                <button type="button" class="btn btn-sm btn-outline-secondary chart-type-btn active" 
                                        data-chart-type="pie" data-pipeline="church">
                                    Pie
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary chart-type-btn" 
                                        data-chart-type="bar" data-pipeline="church">
                                    Bar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row g-3">
        <!-- Pending Tasks -->
        <div class="col-12 col-lg-6">
            <div class="card h-100 card-border-primary-blue">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Pending Tasks</h5>
                    <a href="{{ url_for('tasks.add') }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus"></i> New Task
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Due Date</th>
                                    <th>Priority</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in pending_tasks %}
                                <tr>
                                    <td>{{ task.title }}</td>
                                    <td>{{ task.due_date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <span class="priority-badge priority-{{ task.priority.value }}">
                                            {{ task.priority }}
                                        </span>
                                    </td>
                                    <td>
                                        <form action="{{ url_for('tasks.complete', id=task.id) }}" method="POST" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                            <button type="submit" class="btn btn-sm btn-success" title="Mark Complete">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </form>
                                        <a href="{{ url_for('tasks.edit', id=task.id) }}" class="btn btn-sm btn-primary" title="Edit">
                                            <i class="fas fa-pencil-alt"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">No pending tasks</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="col-12 col-lg-6">
            <div class="card h-100 card-border-primary-green">
                <div class="card-header">
                    <h5 class="mb-0">Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div class="activity-feed">
                        {% for activity in recent_activities %}
                        <div class="activity-item d-flex align-items-start mb-3">
                            <div class="activity-icon me-3">
                                {% if activity.type == 'person' %}
                                <i class="fas fa-user text-primary-blue"></i>
                                {% elif activity.type == 'church' %}
                                <i class="fas fa-church text-primary-green"></i>
                                {% elif activity.type == 'task' %}
                                <i class="fas fa-tasks text-primary-blue"></i>
                                {% elif activity.type == 'communication' %}
                                <i class="fas fa-comment-alt text-primary-green"></i>
                                {% endif %}
                            </div>
                            <div class="activity-content flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="activity-text">{{ activity.description }}</div>
                                    {% if activity.type == 'communication' %}
                                    <a href="{{ url_for('communications.view', id=activity.id) }}" class="btn btn-sm btn-outline-primary ms-2">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% elif activity.type == 'task' %}
                                    <a href="{{ url_for('tasks.edit', id=activity.id) }}" class="btn btn-sm btn-outline-primary ms-2">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% endif %}
                                </div>
                                <small class="text-muted">{{ activity.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-center">No recent activity</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Services Card -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title">Google Services</h5>
        </div>
        <div class="card-body">
            <p>Manage your Google integrations:</p>
            <ul class="list-group">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Gmail Integration
                    <a href="{{ url_for('auth.google_auth') }}" class="btn btn-sm btn-primary">Connect</a>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Reauthorize Google Services
                    <a href="{{ url_for('auth.reauth_google') }}" class="btn btn-sm btn-warning">Reauthorize</a>
                </li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% if current_user.first_login %}
    {% include 'onboarding/welcome_modal.html' %}
{% endif %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global chart objects
let peopleChart = null;
let churchChart = null;

// Function to log messages to console with timestamp
function logMessage(message, data) {
    const timestamp = new Date().toISOString();
    console.log(`[${timestamp}] ${message}`, data || '');
}

// Function to fetch pipeline chart data
function fetchPipelineChartData(chartType) {
    logMessage(`Fetching ${chartType} pipeline data`);
    
    // Show loading indicator
    const loadingId = `${chartType}-chart-loading`;
    const loadingElement = document.getElementById(loadingId);
    if (loadingElement) {
        loadingElement.style.display = 'flex';
    }
    
    // Hide any previous error messages
    const errorId = `${chartType}-chart-error`;
    const errorElement = document.getElementById(errorId);
    if (errorElement) {
        errorElement.style.display = 'none';
    }
    
    // Hide empty state message
    const emptyId = `${chartType}-chart-empty`;
    const emptyElement = document.getElementById(emptyId);
    if (emptyElement) {
        emptyElement.style.display = 'none';
    }

    // Make API request
    const endpoint = `/dashboard/api/chart-data/${chartType}`;
    logMessage(`Requesting data from ${endpoint}`);
    
    fetch(endpoint)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            logMessage(`Received ${chartType} data`, data);
            
            // Check if we have valid data
            if (!data || !data.stages || data.stages.length === 0) {
                showEmptyState(chartType);
                return;
            }
            
            // Render the chart
            renderChart(chartType, data);
            
            // Update total count
            updateTotalCount(chartType, data.total_contacts || 0);
            
            // Update pipeline link if available
            if (data.pipeline_id) {
                updatePipelineLink(chartType, data.pipeline_id);
            }
        })
        .catch(error => {
            logMessage(`Error fetching ${chartType} data: ${error.message}`);
            showError(chartType, error.message);
        })
        .finally(() => {
            // Hide loading indicator
            const loadingElement = document.getElementById(`${chartType}-chart-loading`);
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        });
}

// Function to show empty state message
function showEmptyState(chartType) {
    const emptyElement = document.getElementById(`${chartType}-chart-empty`);
    if (emptyElement) {
        emptyElement.style.display = 'block';
    }
}

// Function to show error message
function showError(chartType, message) {
    const errorElement = document.getElementById(`${chartType}-chart-error`);
    if (errorElement) {
        errorElement.innerHTML = `<strong>Error:</strong> ${message} <button class="btn btn-sm btn-outline-primary retry-btn">Retry</button>`;
        errorElement.style.display = 'block';
        
        // Add event listener to retry button
        const retryBtn = errorElement.querySelector('.retry-btn');
        if (retryBtn) {
            retryBtn.addEventListener('click', function() {
                fetchPipelineChartData(chartType);
            });
        }
    }
}

// Function to update total count display
function updateTotalCount(chartType, count) {
    const totalCountElement = document.getElementById(`${chartType}-total-count`);
    if (totalCountElement) {
        const label = chartType === 'person' ? 'People' : 'Churches';
        totalCountElement.textContent = `Total: ${count} ${label}`;
    }
}

// Function to update pipeline link
function updatePipelineLink(chartType, pipelineId) {
    const linkElement = document.getElementById(`${chartType}-view-pipeline`);
    if (linkElement && pipelineId) {
        linkElement.href = `/pipeline/${pipelineId}`;
    }
}

// Function to render chart
function renderChart(chartType, data) {
    // Get chart container
    const containerId = `${chartType}-chart-container`;
    const container = document.getElementById(containerId);
    if (!container) {
        logMessage(`Chart container not found: ${containerId}`);
        return;
    }
    
    // Clear existing chart if any
    if (chartType === 'person' && peopleChart) {
        peopleChart.destroy();
        peopleChart = null;
    } else if (chartType === 'church' && churchChart) {
        churchChart.destroy();
        churchChart = null;
    }
    
    // Create canvas for chart
    const canvasId = `${chartType}-chart-canvas`;
    let canvas = document.getElementById(canvasId);
    if (!canvas) {
        canvas = document.createElement('canvas');
        canvas.id = canvasId;
        container.innerHTML = '';
        container.appendChild(canvas);
    }
    
    // Prepare chart data
    const labels = data.stages.map(stage => stage.name);
    const counts = data.stages.map(stage => stage.contact_count || 0);
    const colors = data.stages.map(stage => stage.color || getDefaultColor(stage.name));
    
    // Get preferred chart type (pie or bar)
    const chartTypeButtons = document.querySelectorAll(`#${chartType}-chart-type-buttons .chart-type-btn`);
    let chartStyle = 'pie'; // Default
    
    chartTypeButtons.forEach(button => {
        if (button.classList.contains('active')) {
            chartStyle = button.getAttribute('data-chart-type');
        }
    });
    
    // Create chart
    const ctx = canvas.getContext('2d');
    const chartConfig = createChartConfig(chartStyle, labels, counts, colors);
    
    // Create and store chart instance
    if (chartType === 'person') {
        peopleChart = new Chart(ctx, chartConfig);
    } else {
        churchChart = new Chart(ctx, chartConfig);
    }
    
    logMessage(`Rendered ${chartStyle} chart for ${chartType} pipeline`);
}

// Function to get default color if stage color is missing
function getDefaultColor(stageName) {
    // Lowercase stage name for case-insensitive matching
    const name = (stageName || '').toLowerCase();
    
    if (name.includes('promotion')) return '#3498db'; // Blue
    if (name.includes('information')) return '#2ecc71'; // Green
    if (name.includes('invitation')) return '#f1c40f'; // Yellow
    if (name.includes('confirmation')) return '#e67e22'; // Orange
    if (name.includes('enr') || name.includes('en42')) return '#9b59b6'; // Purple
    if (name.includes('automation')) return '#1abc9c'; // Teal
    
    // Default colors
    return '#95a5a6'; // Gray
}

// Function to create chart configuration
function createChartConfig(chartStyle, labels, counts, colors) {
    // Common options for both chart types
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.raw || 0;
                        const total = counts.reduce((sum, count) => sum + count, 0);
                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                        return `${label}: ${value} (${percentage}%)`;
                    }
                },
                titleFont: { size: 14 },
                bodyFont: { size: 14 }
            }
        }
    };
    
    // Configure chart based on type
    if (chartStyle === 'pie') {
        return {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: counts,
                    backgroundColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                ...commonOptions,
                plugins: {
                    ...commonOptions.plugins,
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 15,
                            padding: 15,
                            font: { size: 13 }
                        }
                    }
                }
            }
        };
    } else {
        // Bar chart
        return {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Count',
                    data: counts,
                    backgroundColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0, // No decimal places for integer counts
                            font: { size: 12 }
                        }
                    },
                    x: {
                        ticks: {
                            font: { size: 12 }
                        }
                    }
                },
                plugins: {
                    ...commonOptions.plugins,
                    legend: {
                        display: false
                    }
                }
            }
        };
    }
}

// Function to test the pipeline API
function testPipelineApi(chartType) {
    const timestamp = new Date().toISOString();
    console.log(`[${timestamp}] Testing pipeline API for ${chartType}...`);
    
    // Get status element
    let statusElementId = chartType === 'person' ? 'people-chart-status' : 'church-chart-status';
    const statusElement = document.getElementById(statusElementId) || document.createElement('div');
    statusElement.id = statusElementId;
    statusElement.innerHTML = '<span class="text-info"><i class="fas fa-sync-alt fa-spin me-2"></i>Testing API...</span>';
    
    // Add status element if not present
    const chartContainer = document.querySelector(`#${chartType}PipelineChart`).parentNode;
    if (!chartContainer.contains(statusElement)) {
        chartContainer.appendChild(statusElement);
    }
    
    // Use our debug endpoint for chart data
    fetchPipelineChartData(chartType)
        .then(data => {
            console.log(`[${timestamp}] API test successful:`, data);
            
            // Calculate total contacts for display
            const totalContacts = data.total_contacts || 0;
            const contactType = chartType === 'person' ? 'People' : 'Churches';
            
            // Format stage distribution for the alert
            let stageDistribution = '';
            if (data.stages && data.stages.length > 0) {
                stageDistribution = data.stages.map(stage => 
                    `${stage.name}: ${stage.contact_count} (${stage.percentage}%)`
                ).join('\n');
            }
            
            // Create success message
            const successMsg = `API test successful!\n\nPipeline: ${data.pipeline_name}\nTotal ${contactType}: ${totalContacts}\n\nStage Distribution:\n${stageDistribution}`;
            
            // Update UI
            statusElement.innerHTML = '<span class="text-success"><i class="fas fa-check-circle me-2"></i>API working!</span>';
            
            // Show alert with data summary
            alert(successMsg);
            
            // Force refresh the chart
            fetchPipelineChartData(chartType);
        })
        .catch(error => {
            console.error(`[${timestamp}] API test failed:`, error);
            statusElement.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle me-2"></i>API error!</span>';
            alert(`API Test Failed: ${error.message}`);
        });
}

// Initialize chart type buttons
function initChartTypeButtons() {
    // Add event listeners to chart type buttons
    document.querySelectorAll('.chart-type-btn').forEach(button => {
        button.addEventListener('click', function() {
            const chartType = this.getAttribute('data-pipeline');
            const newChartStyle = this.getAttribute('data-chart-type');
            
            // Update active state for all buttons in this group
            const buttonGroup = this.closest('.btn-group');
            if (buttonGroup) {
                buttonGroup.querySelectorAll('.chart-type-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
            }
            
            // Save preference to localStorage
            localStorage.setItem(`${chartType}-chart-style`, newChartStyle);
            
            // Refresh the chart with new style
            fetchPipelineChartData(chartType);
        });
    });
}

// Initialize refresh buttons
function initRefreshButtons() {
    document.querySelectorAll('.refresh-chart-btn').forEach(button => {
        button.addEventListener('click', function() {
            const chartType = this.getAttribute('data-chart-type');
            fetchPipelineChartData(chartType);
        });
    });
}

// Apply saved chart style preferences
function applySavedChartStyles() {
    ['person', 'church'].forEach(chartType => {
        const savedStyle = localStorage.getItem(`${chartType}-chart-style`);
        if (savedStyle) {
            const buttonSelector = `#${chartType}-chart-type-buttons .chart-type-btn[data-chart-type="${savedStyle}"]`;
            const button = document.querySelector(buttonSelector);
            if (button) {
                // Update active state for all buttons in this group
                const buttonGroup = button.closest('.btn-group');
                if (buttonGroup) {
                    buttonGroup.querySelectorAll('.chart-type-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    button.classList.add('active');
                }
            }
        }
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    logMessage('Initializing dashboard charts');
    
    // Initialize button event handlers
    initChartTypeButtons();
    initRefreshButtons();
    
    // Apply saved chart style preferences
    applySavedChartStyles();
    
    // Load chart data
    fetchPipelineChartData('person');
    fetchPipelineChartData('church');
});
</script>
{% endblock %}