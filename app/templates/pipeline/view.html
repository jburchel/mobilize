{% extends "base.html" %}

{% block title %}{{ pipeline.name }} Pipeline{% endblock %}

{% block styles %}
<style>
    .pipeline-board {
        overflow-x: auto;
        min-height: 70vh;
    }
    .pipeline-stage {
        min-width: 280px;
        max-width: 280px;
        background-color: #f8f9fa;
        border-radius: 6px;
        box-shadow: 0 2px 3px rgba(0,0,0,0.1);
    }
    .pipeline-stage-header {
        background-color: #fff;
        border-bottom: 1px solid rgba(0,0,0,.125);
        border-top-left-radius: 6px;
        border-top-right-radius: 6px;
        padding: 10px 15px;
    }
    .pipeline-stage-body {
        max-height: calc(100vh - 250px);
        overflow-y: auto;
        padding: 15px;
    }
    .pipeline-stage-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    .contact-card {
        margin-bottom: 10px;
        border-radius: 4px;
        border: 1px solid rgba(0,0,0,.125);
        background-color: #fff;
        transition: all 0.2s ease-in-out;
    }
    .contact-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .days-indicator {
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 10px;
    }
    .days-0-2 { background-color: #d1e7dd; }
    .days-3-7 { background-color: #fff3cd; }
    .days-8-plus { background-color: #f8d7da; }
    .contact-actions {
        visibility: hidden;
        position: absolute;
        right: 10px;
        top: 10px;
    }
    .contact-card:hover .contact-actions {
        visibility: visible;
    }
    .drag-placeholder {
        background-color: rgba(0,0,0,0.05);
        border: 2px dashed #adb5bd;
        border-radius: 4px;
        margin-bottom: 10px;
        height: 80px;
    }
    .stage-count {
        font-size: 0.8rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <div class="row mb-4">
        <div class="col">
            <h2>{{ pipeline.name }}</h2>
            <p class="text-muted">{{ pipeline.description }}</p>
        </div>
        <div class="col-auto">
            <div class="btn-group">
                <a href="{{ url_for('pipeline.add_contact', pipeline_id=pipeline.id) }}" class="btn btn-primary">
                    <i class="bi bi-person-plus me-1"></i> Add 
                    {% if pipeline_type == 'church' %}Churches{% else %}Contacts{% endif %}
                </a>
                {% if not pipeline.is_main_pipeline or current_user.is_super_admin() %}
                <a href="{{ url_for('pipeline.manage_stages', pipeline_id=pipeline.id) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-diagram-3 me-1"></i> Edit Stages
                </a>
                <a href="{{ url_for('pipeline.edit', pipeline_id=pipeline.id) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-gear me-1"></i> Settings
                </a>
                {% endif %}
                <a href="{{ url_for('pipeline.index') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Back
                </a>
            </div>
        </div>
    </div>

    {% if not stages %}
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        This pipeline has no stages. 
        {% if not pipeline.is_main_pipeline or current_user.is_super_admin() %}
        <a href="{{ url_for('pipeline.manage_stages', pipeline_id=pipeline.id) }}">Click here</a> to add stages.
        {% endif %}
    </div>
    {% elif stages|length > 0 %}
    <div class="pipeline-board d-flex pt-2">
        {% for stage in stages %}
        <div class="pipeline-stage me-3">
            <div class="pipeline-stage-header d-flex justify-content-between align-items-center">
                <div>
                    <span class="pipeline-stage-indicator" style="background-color: {{ stage.color }};"></span>
                    <span class="fw-bold">{{ stage.name }}</span>
                </div>
                <span class="stage-count">{{ contacts_by_stage[stage.id]|length }}</span>
            </div>
            <div class="pipeline-stage-body" data-stage-id="{{ stage.id }}">
                {% if contacts_by_stage[stage.id]|length > 0 %}
                    {% for contact in contacts_by_stage[stage.id] %}
                    <div class="contact-card p-3 position-relative" data-pipeline-contact-id="{{ contact.pipeline_contact.id }}">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1">{{ contact.contact.get_name() }}</h6>
                            
                            {% if contact.days_in_stage is defined %}
                                {% if contact.days_in_stage <= 2 %}
                                    <span class="days-indicator days-0-2">{{ contact.days_in_stage }} days</span>
                                {% elif contact.days_in_stage <= 7 %}
                                    <span class="days-indicator days-3-7">{{ contact.days_in_stage }} days</span>
                                {% else %}
                                    <span class="days-indicator days-8-plus">{{ contact.days_in_stage }} days</span>
                                {% endif %}
                            {% endif %}
                        </div>
                        
                        <div class="small text-muted mb-2">
                            {% if contact.email %}
                            <div><i class="bi bi-envelope me-1"></i> {{ contact.email }}</div>
                            {% endif %}
                            {% if contact.phone %}
                            <div><i class="bi bi-telephone me-1"></i> {{ contact.phone }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="contact-actions">
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary move-contact-btn" 
                                        data-bs-toggle="modal" data-bs-target="#moveContactModal"
                                        data-pipeline-contact-id="{{ contact.pipeline_contact.id }}"
                                        data-contact-name="{{ contact.contact.get_name() }}">
                                    <i class="bi bi-arrows-move"></i>
                                </button>
                                <a href="{{ url_for('pipeline.history', pipeline_id=pipeline.id, pipeline_contact_id=contact.pipeline_contact.id) }}" 
                                   class="btn btn-outline-info">
                                    <i class="bi bi-clock-history"></i>
                                </a>
                                <button type="button" class="btn btn-outline-danger remove-contact-btn"
                                        data-bs-toggle="modal" data-bs-target="#removeContactModal"
                                        data-pipeline-contact-id="{{ contact.pipeline_contact.id }}"
                                        data-contact-name="{{ contact.contact.get_name() }}">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center p-3 text-muted">
                    <i class="bi bi-inbox mb-2" style="font-size: 1.5rem;"></i>
                    <p class="mb-0">No contacts in this stage</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        Start by adding stages to your pipeline.
    </div>
    {% endif %}
</div>

<!-- Move Contact Modal -->
<div class="modal fade" id="moveContactModal" tabindex="-1" aria-labelledby="moveContactModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="moveContactModalLabel">Move Contact</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="moveContactForm" action="" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="modal-body">
                    <p>Move <span id="contactNameDisplay"></span> to:</p>
                    <div class="mb-3">
                        <label for="stage_id" class="form-label">Select Stage</label>
                        <select class="form-select" id="stage_id" name="stage_id" required>
                            {% for stage in stages %}
                            <option value="{{ stage.id }}">{{ stage.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" 
                                  placeholder="Add any notes about this movement"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Move Contact</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Remove Contact Modal -->
<div class="modal fade" id="removeContactModal" tabindex="-1" aria-labelledby="removeContactModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="removeContactModalLabel">Remove Contact</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="removeContactForm" action="" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="modal-body">
                    <p>Are you sure you want to remove <span id="removeContactNameDisplay"></span> from this pipeline?</p>
                    <p class="text-muted">This will remove the contact from the pipeline and delete all stage history for this contact in this pipeline.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Remove Contact</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Move contact modal setup
        const moveContactModal = document.getElementById('moveContactModal');
        if (moveContactModal) {
            moveContactModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const pipelineContactId = button.getAttribute('data-pipeline-contact-id');
                const contactName = button.getAttribute('data-contact-name');
                
                document.getElementById('contactNameDisplay').textContent = contactName;
                document.getElementById('moveContactForm').action = 
                    "{{ url_for('pipeline.move_contact', pipeline_contact_id=0) }}".replace('0', pipelineContactId);
            });
        }
        
        // Remove contact modal setup
        const removeContactModal = document.getElementById('removeContactModal');
        if (removeContactModal) {
            removeContactModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const pipelineContactId = button.getAttribute('data-pipeline-contact-id');
                const contactName = button.getAttribute('data-contact-name');
                
                document.getElementById('removeContactNameDisplay').textContent = contactName;
                document.getElementById('removeContactForm').action = 
                    "{{ url_for('pipeline.remove_contact', pipeline_contact_id=0) }}".replace('0', pipelineContactId);
            });
        }
    });
</script>
{% endblock %} 